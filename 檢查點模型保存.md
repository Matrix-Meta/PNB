# 檢查點模型保存（MNIST Surrogate）

本專案的 `train_mnist_surrogate` 已加入「訓練中自動保存檢查點」能力，用於保存當前模型權重與關鍵的仿生動態狀態，方便回溯最佳結果或中斷後續訓（目前先提供**保存**；載入/續訓可再加）。

## 會保存什麼

檢查點會把「能影響推理/訓練行為」的狀態一起保存，包含：

- **四個投影層（BitLinear）**：`proj_in / proj_mid1 / proj_mid2 / proj_out` 的 `weight/bias`
- **Hippocampus 記憶權重**：`W_fast / W_slow`
- **Glial**：門檻值與控制狀態（包含 EMA、積分項、速度、噪聲增益等）
- **M‑DSiLU（Activation）**：
  - 基本參數（`vigilance/tau/alpha/novelty_power/novelty_sharpness`）
  - per‑group 的 `group_offsets`（用於 homeostatic + 分組閾值調節）
- **Neuromodulator**：
  - learned weights（4 維）
  - last control（最近一次輸出的 target/調節參數）
- **SSM**：`A` 與 `state`（若有）
- **Meta**：epoch、seed、learning rate、train/val 的 acc/loss/unc、維度資訊等

## 檔案輸出

預設輸出到根目錄的 `checkpoints/`：

- `checkpoints/mnist_surrogate_last.pnbckpt`：每輪覆寫一次（最新）
- `checkpoints/mnist_surrogate_best.pnbckpt`：遇到更佳驗證表現就覆寫（最佳）
- `checkpoints/mnist_surrogate_epoch{N}.pnbckpt`：可選（定期保存）

> 格式為自定義二進位（`PNBCKPT1`），建議僅在**相同/相近版本的程式碼**下使用。

## CLI 參數

在 `train_mnist_surrogate` 可用下列參數控制保存行為：

- `--ckpt` / `--no-ckpt`：開/關檢查點（預設開）
- `--ckpt-dir <dir>` 或 `--ckpt-dir=<dir>`：輸出資料夾（預設 `checkpoints`）
- `--ckpt-every N` 或 `--ckpt-every=N`：每 `N` 輪額外保存一份 `epochN`（`0` 表示停用）
- `--ckpt-best` / `--no-ckpt-best`：開/關 best 保存（預設開）
- `--ckpt-last` / `--no-ckpt-last`：開/關 last 保存（預設開）

範例：

```bash
./train_mnist_surrogate --epochs 75 --hidden 2048 --batch 256 --seed 1337 --ckpt-every 5
```

## 目前限制

- 目前只加入 **保存**；尚未加入 `--resume` / `--load-ckpt` 的載入與續訓流程。
- 檢查點包含大量浮點權重（尤其 `W_fast/W_slow`），檔案大小會隨 `Hidden` 增長。

